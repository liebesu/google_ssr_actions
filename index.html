<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google SSR Actions - 订阅聚合</title>
  <link rel="stylesheet" href="styles.css" />
  <script>
    const AUTH_HASH = "1dd2557b6334b098dc895f52fe46add7880094aec59a2eece3e4c5da2fc79f86";
    const AUTH_USER = "liebesu";
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function showAuth() {
      const mask = document.getElementById('auth-mask');
      const userInput = document.getElementById('auth-user');
      const passInput = document.getElementById('auth-input');
      const err = document.getElementById('auth-err');
      const btn = document.getElementById('auth-btn');
      mask.style.display = 'flex';
      userInput.focus();
      async function submit() {
        const user = userInput.value.trim();
        const pwd = passInput.value || '';
        const h = await sha256(pwd);
        const userRequired = (AUTH_USER || '').trim().length > 0;
        const userOk = userRequired ? (user === (AUTH_USER||'').trim()) : true;
        if (userOk && h.toLowerCase() === AUTH_HASH.toLowerCase()) {
          try{ localStorage.setItem('gauth', h); localStorage.setItem('guser', user); }catch(e){}
          mask.style.display = 'none';
          document.documentElement.style.display = '';
        } else {
          err.textContent = '用户名或密码错误，请重试';
        }
      }
      btn.addEventListener('click', submit);
      passInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submit(); }});
    }
    function gate() {
      if (!AUTH_HASH) { document.documentElement.style.display = ''; return; }
      try{
        const tk = localStorage.getItem('gauth');
        const gu = (localStorage.getItem('guser') || '').trim();
        const userRequired = (AUTH_USER || '').trim().length > 0;
        const passOk = !!tk && (tk.toLowerCase() === AUTH_HASH.toLowerCase());
        const userOk = userRequired ? (gu === (AUTH_USER||'').trim()) : true;
        if (passOk && userOk) { document.documentElement.style.display = ''; return; }
      }catch(e){}
      showAuth();
    }
    document.documentElement.style.display = 'none';
    document.addEventListener('DOMContentLoaded', gate);
    // 根据是否有配额数据隐藏卡片
    document.addEventListener('DOMContentLoaded', ()=>{
      const qleft = '1500'; const qcap = '2000'; const kok='4'; const kt='5';
      const hideQuota = (!qleft || qleft==='0') && (!qcap || qcap==='0') && (!kok || kok==='0') && (!kt || kt==='0');
      if(hideQuota){
        document.querySelectorAll('.stat.quota').forEach(el=>el.style.display='none');
      }
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div id="auth-mask" class="auth-mask" style="display:none">
      <div class="auth-card">
        <h3 class="auth-title">访问认证</h3>
        <p class="auth-sub">请输入用户名和密码以查看页面内容</p>
        <input id="auth-user" class="auth-input" type="text" placeholder="输入用户名" />
        <input id="auth-input" class="auth-input" type="password" placeholder="输入密码" />
        <button id="auth-btn" class="auth-btn">进入</button>
        <div id="auth-err" class="auth-err"></div>
      </div>
    </div>
    <div class="header">
      <h1>Google SSR Actions</h1>
      <small>构建时间(中国时区)：2025-09-24 05:30:00</small>
    </div>
    <div class="subtitle">源 47/61 · 节点 556 · 新增 3 · 移除 2</div>

    <div class="stats" id="stats-cards">
      <div class="stat quota" data-hide="q"><div class="num">1500</div><div>剩余额度</div></div>
      <div class="stat quota" data-hide="q"><div class="num">2000</div><div>总额度</div></div>
      <div class="stat quota" data-hide="q"><div class="num">4/5</div><div>可用密钥/总密钥</div></div>
      <div class="stat"><div class="num">2025-09-24 08:30:00</div><div>下次更新时间(中国时区)</div></div>
    </div>

    <div class="grid">
      <div class="card card-metrics">
        <h3>关键指标（7/30天）</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
          <div>
            <small>新增(7天)</small>
            <canvas id="spark-added-7" height="40"></canvas>
          </div>
          <div>
            <small>失效(7天)</small>
            <canvas id="spark-removed-7" height="40"></canvas>
          </div>
          <div>
            <small>存活(30天)</small>
            <canvas id="spark-alive-30" height="40"></canvas>
          </div>
        </div>
      </div>
      <div class="card card-files">
        <h3>订阅文件</h3>
        <ul>
          <li><a href="sub/all.txt"><code>sub/all.txt</code></a> 全量订阅</li>
          <li><a href="sub/all.yaml"><code>sub/all.yaml</code></a> Clash配置</li>
        </ul>
      </div>

      <div class="card card-sources">
        <h3>URL 源</h3>
        <ul>
          <li><a href="sub/urls.txt"><code>urls.txt</code></a> 当前可用源</li>
          <li><a href="sub/all_urls.txt"><code>all_urls.txt</code></a> 完整源列表</li>
          <li><a href="sub/google_urls.txt"><code>google_urls.txt</code></a> Google发现（25）</li>
          <li><a href="sub/github_urls.txt"><code>github_urls.txt</code></a> GitHub发现（22）</li>
        </ul>
      </div>

      <div class="card card-health">
        <h3>健康信息</h3>
        <ul class="health-list">
          <li>构建时间(中国时区)：<b>2025-09-24 05:30:00</b></li>
          <li>下次更新时间(中国时区)：<b>2025-09-24 08:30:00</b></li>
          <li>源：<b>47/61</b> · 新增 <b>3</b> · 移除 <b>2</b></li>
          <li>节点：<b>556</b> · 协议 SS <b>120</b> | VMess <b>200</b> | VLESS <b>150</b> | Trojan <b>50</b> | HY2 <b>36</b></li>
          <li>来源：Google <b>25</b> | GitHub <b>22</b></li>
        </ul>
      </div>

      <div class="card card-serpapi">
        <h3>SerpAPI 密钥状态</h3>
        <div id="serpapi-status">
          <div class="serpapi-summary">
            <span class="status-item">可用密钥: <b id="keys-ok">4</b>/<b id="keys-total">5</b></span>
            <span class="status-item">总剩余额度: <b id="quota-left">1500</b>/<b id="quota-cap">2000</b></span>
          </div>
          <div id="serpapi-keys-list" class="serpapi-keys-list">
            <!-- 动态加载密钥详情 -->
          </div>
        </div>
      </div>

      <div class="card card-protocols">
        <h3>协议分布</h3>
        <ul>
          <li>SS：120</li>
          <li>VMess：200</li>
          <li>VLESS：150</li>
          <li>Trojan：50</li>
          <li>Hysteria2：36</li>
        </ul>
      </div>

      <div class="card card-extras">
        <h3>辅助输出</h3>
        <ul>
          <li><a href="sub/github.txt"><code>github.txt</code></a> GitHub节点</li>
          <li><a href="sub/proto/ss-base64.txt"><code>ss-base64.txt</code></a> SS Base64</li>
          <li><a href="health.json"><code>health.json</code></a> 健康信息</li>
        </ul>
      </div>

      <div class="card card-wide card-details">
        <h3>源详细信息</h3>
        <p><small>包含机场名称、容量/剩余、协议、复制与测速、详情页。</small></p>
        <div id="url-meta"><small>加载中...</small></div>
        <div class="chart">
          <h4 style="margin:0 0 8px 0">每日新增可用URL</h4>
          <canvas id="dailyChart" height="120"></canvas>
        </div>
        <script>
          function copyText(text){
            navigator.clipboard.writeText(text).then(()=>{
              alert('已复制订阅链接');
            }).catch(()=>{});
          }
          async function testSpeed(url){
            const t0 = performance.now();
            try{ await fetch(url, {method:'HEAD', mode:'no-cors'}); }catch(e){}
            const t1 = performance.now();
            return Math.round(t1 - t0);
          }
          async function runBatchSpeed(urls, concurrency){
            const results = new Array(urls.length).fill(null);
            let idx = 0;
            async function worker(){
              while(idx < urls.length){
                const i = idx++;
                const u = urls[i];
                const ms = await testSpeed(u);
                results[i] = ms;
                const cell = document.querySelector(`[data-url-id="${i}"]`);
                if(cell){
                  cell.textContent = ms;
                  cell.style.color = ms<=300?'#10b981':(ms<=800?'#60a5fa':'#f59e0b');
                }
              }
            }
            const workers = Array.from({length: Math.min(concurrency, urls.length)}, ()=>worker());
            await Promise.all(workers.map(w=>w()));
            return results;
          }
          async function loadMeta() {
            try {
              const res = await fetch('sub/url_meta.json', { cache: 'no-cache' });
              if (!res.ok) throw new Error('fetch failed');
              let data = await res.json();
              // 只展示可用源
              data = (Array.isArray(data) ? data : []).filter(x=>x && x.available);
              // 按质量分倒序排序
              data.sort((a,b)=> (b.quality_score||0) - (a.quality_score||0));
              const rows = data.map(function(item, i){
                const q = (item.quality_score ?? 0);
                const qColor = q>=80?'#10b981':(q>=60?'#60a5fa':'#f59e0b');
                const src = (item.source||'').toLowerCase();
                const pillColor = src==='github'?'#111827': '#0b1220';
                const pillText = src==='github'?'GitHub':'Google';
                return '<tr>' +
                  '<td><div style="display:flex;gap:8px;align-items:center">' +
                    '<a href="' + (item.url||'#') + '" target="_blank">源</a>' +
                    '<small style="color:#94a3b8">' + (item.provider||item.host||'') + '</small>' +
                  '</div></td>' +
                  '<td>' + (item.available ? '✅' : '❌') + '</td>' +
                  '<td>' + (item.nodes_total ?? 0) + '</td>' +
                  '<td>' + (item.protocols ?? '') + '</td>' +
                  '<td>' + ((item.traffic?.remaining ?? '-') + ' / ' + (item.traffic?.total ?? '-') + ' ' + (item.traffic?.unit ?? '')) + '</td>' +
                  '<td data-url-id="' + i + '">' + (item.response_ms ?? '-') + '</td>' +
                  '<td><b style="color:' + qColor + '">' + q + '</b></td>' +
                  '<td><span class="pill" style="background:' + pillColor + '">' + pillText + '</span></td>' +
                  '<td>' + (item.first_seen || '-') + '</td>' +
                  '<td>' +
                    '<button onclick="copyText(\'' + (item.url||'') + '\')" style="padding:4px 8px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb">复制</button>' +
                    '<button class="btn-speed" data-url="' + (item.url||'') + '" style="margin-left:6px;padding:4px 8px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb">测速</button>' +
                    (item.detail_page ? '<a href="' + item.detail_page + '" style="margin-left:8px">详情</a>' : '') +
                  '</td>' +
                '</tr>';
              }).join('');
              const html = '<table>' +
                '<thead><tr>' +
                '<th style="text-align:left">URL/机场</th>' +
                '<th>可用</th>' +
                '<th>节点数</th>' +
                '<th>协议</th>' +
                '<th>流量(剩余/总量)</th>' +
                '<th>耗时(ms)</th>' +
                '<th>质量</th>' +
                '<th>来源</th>' +
                '<th>采集</th>' +
                '<th>操作</th>' +
                '</tr></thead>' +
                '<tbody>' + rows + '</tbody>' +
                '</table>';
              document.getElementById('url-meta').innerHTML = html;
              // 绑定单击测速
              document.querySelectorAll('.btn-speed').forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                  const u = e.currentTarget.getAttribute('data-url');
                  const ms = await testSpeed(u);
                  e.currentTarget.closest('tr').querySelector('[data-url-id]').textContent = ms;
                });
              });
              // 批量测速（限并发 6）
              const urls = data.map(x=>x.url);
              runBatchSpeed(urls, 6);
            } catch(e) {
              document.getElementById('url-meta').innerHTML = '<small>未获取到源详情</small>';
            }
          }
          async function loadDailyChart() {
            try {
              const r = await fetch('sub/stats_daily.json', { cache:'no-cache' });
              if (!r.ok) return;
              const d = await r.json();
              const labels = d.map(x=>x.date);
              const google = d.map(x=>x.google_added||0);
              const github = d.map(x=>x.github_added||0);
              const added = d.map(x=>x.new_total||0);
              const removed = d.map(x=>x.removed_total||0);
              const canvas = document.getElementById('dailyChart');
              const ctx = canvas.getContext('2d');
              // 极简绘制
              const max = Math.max(1, ...google, ...github, ...added, ...removed);
              const W = canvas.width = canvas.clientWidth;
              const H = canvas.height;
              function plot(series, color, yoff) {
                ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
                series.forEach((v,i)=>{
                  const x = (W-20) * (i/(series.length-1)) + 10;
                  const y = H-10 - (H-20) * (v/max);
                  if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }); ctx.stroke();
              }
              ctx.clearRect(0,0,W,H); ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,W,H);
              plot(google,'#60a5fa'); plot(github,'#10b981'); plot(added,'#a78bfa'); plot(removed,'#f87171');
            } catch(e) {}
          }
          function drawSparkline(canvasId, series, color){
            const c = document.getElementById(canvasId); if(!c) return; const ctx=c.getContext('2d');
            const W = c.width = c.clientWidth || 160; const H = c.height; const max = Math.max(1, ...series);
            ctx.clearRect(0,0,W,H); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
            series.forEach((v,i)=>{ const x=(W-6)*(i/(series.length-1))+3; const y=H-3 - (H-6)*(v/max); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
            ctx.stroke();
          }
          async function loadSparklines(){
            try{
              const r = await fetch('sub/stats_daily.json', { cache:'no-cache' }); if(!r.ok) return;
              const d = await r.json();
              const last7 = d.slice(-7);
              const last30 = d.slice(-30);
              drawSparkline('spark-added-7', last7.map(x=>x.new_total||0), '#60a5fa');
              drawSparkline('spark-removed-7', last7.map(x=>x.removed_total||0), '#f87171');
              drawSparkline('spark-alive-30', last30.map(x=>x.alive_total||0), '#10b981');
            }catch(e){}
          }

          // 加载 SerpAPI 密钥详情
          async function loadSerpAPIKeys() {
            try {
              const r = await fetch('health.json', { cache:'no-cache' });
              if(!r.ok) return;
              const health = await r.json();
              const keys = health.serpapi_keys_detail || [];
              const container = document.getElementById('serpapi-keys-list');
              if(!container) return;
              
              if(keys.length === 0) {
                container.innerHTML = '<div class="serpapi-key-item error">暂无密钥信息</div>';
                return;
              }
              
              container.innerHTML = keys.map(key => {
                if(key.error) {
                  return `<div class="serpapi-key-item error">Key ${key.index}: ${key.error}</div>`;
                }
                const used = key.used_searches || 0;
                const total = key.searches_per_month || 0;
                const left = key.total_searches_left || 0;
                const usagePercent = total > 0 ? Math.round((used / total) * 100) : 0;
                const statusClass = left <= 0 ? 'exhausted' : (usagePercent > 80 ? 'warning' : 'ok');
                const resetDate = key.reset_date ? new Date(key.reset_date).toLocaleDateString('zh-CN') : '未知';
                
                return `
                  <div class="serpapi-key-item ${statusClass}">
                    <div class="key-header">
                      <span class="key-index">Key ${key.index}</span>
                      <span class="key-status">${left <= 0 ? '已用尽' : (usagePercent > 80 ? '即将用尽' : '正常')}</span>
                    </div>
                    <div class="key-details">
                      <div class="quota-bar">
                        <div class="quota-fill" style="width: ${usagePercent}%"></div>
                      </div>
                      <div class="quota-text">已用 ${used}/${total} (${usagePercent}%) · 剩余 ${left}</div>
                      <div class="reset-info">重置时间: ${resetDate}</div>
                    </div>
                  </div>
                `;
              }).join('');
            } catch(e) { 
              console.warn('SerpAPI keys load failed:', e);
              const container = document.getElementById('serpapi-keys-list');
              if(container) container.innerHTML = '<div class="serpapi-key-item error">加载失败</div>';
            }
          }
          loadMeta(); loadDailyChart(); loadSparklines(); loadSerpAPIKeys();
        </script>
      </div>
    </div>

    <p><small>仅展示可用源（自动过滤失效/超额/限速来源）。 构建(UTC)：2025-09-23 21:30:00 · 下次(UTC)：2025-09-24 00:30:00</small></p>
  </div>
</body>
</html>

